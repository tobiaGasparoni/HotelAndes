SELECT COUNT(ID)
FROM CONSUMOS;
--RF1: REGISTRO ROLES USUARIOS
ALTER TABLE USUARIOS DROP CONSTRAINT check_tipo;
ALTER TABLE USUARIOS ADD CONSTRAINT check_tipo CHECK(TIPO IN('CLIENTE','RECEPCIONISTA','EMPLEADO','ADMINISTRADOR','GERENTE','ORGANIZADOR_EVENTOS'));
--RF2: REGISTRO USUARIO
INSERT INTO USUARIOS VALUES(1140902288,'CC','GERENTE','Joaquin Phoenix','a@aol.com','a','123456');
COMMIT;
--RF3: REGISTRO TIPO HABITACION
INSERT INTO TIPOS_HABITACION VALUES(1,'Familiar','Para 6 a 8 personas, con comedor y cocina');
COMMIT;
--RF4: REGISTRO HABITACION
INSERT INTO HABITACIONES VALUES(1,8,0,0,0,1,1);
COMMIT;
--RF5: REGISTRO DE UN SERVICIO
--Ejemplo, restaurante
INSERT INTO RESTAURANTE (ID,NOMBRE,CAPACIDAD,OCUPACION_ACTUAL,ESTILO,ID_HOTEL) VALUES ('16697628799','Erat Incorporated',30,17,'Integer','89973308199');
COMMIT;
--RF6: REGISTRO PLAN DE CONSUMO
--Larga estadía: genera un descuento (%) en el costo del alojamiento para estadías mayores a 7 noches
INSERT INTO PLANES VALUES(3,'Lo tienes todo!','TODO_INCLUIDO',200000,0,0,0,'Cerveza nacional artesanal:N/A;Ginebra:3;Pasta:N/A;');
COMMIT;
--RF7: REGISTRO RESERVA DE ALOJAMIENTO
INSERT INTO RESERVAS VALUES(1,SYSDATE,SYSDATE,5,1,3);
INSERT INTO JOIN_RESERVA_TO_CLIENTE VALUES(1,'CC',9357853112,'CLIENTE');
COMMIT;
--RF8: REGISTRO RESERVA DE SERVICIO DE HOTEL DESDE UN CLIENTE
INSERT INTO RESERVAS_SERVICIO VALUES(1,180000,'Reserva especial para una noche en el spa','JAN 2, 2018','Jason Momoa',1,'COMODIDAD',1,'CC',9357853112,'CLIENTE');
--RF9: REGISTRAR LA LLEGADA DE UN CLIENTE AL HOTEL
UPDATE HABITACIONES SET LLEGADA_CLIENTE = 1 WHERE ID = 6;
--RF10: REGISTRAR UN CONSUMO DE UN SERVICIO DEL HOTEL POR CLIENTE O ACOMPANANTES
INSERT INTO CONSUMOS VALUES(1,SYSDATE,25000,'Carne',NULL,NULL,2,NULL,1);
--RF11: REGISTRAR LA SALIDA DE UN CLIENTE
UPDATE HABITACIONES SET LLEGADA_CLIENTE = 0 WHERE ID = 6;
--PENDIENTE!!!!
--Se suma los costos de los consumos del cliente a una nueva cuenta del hotel y el cliente tiene un atributo paz y salvo?


--RFC1: MOSTRAR EL DINERO RECOLECTADO POR SERVICIOS EN CADA HABITACIÓN DURANTE UN PERIODO DE TIEMPO Y EN EL AÑO CORRIDO
--Preparacion: muchos consumos puestos (de diferentes servicios) en la tabla CONSUMOS

SELECT ID_HABITACION HABITACION, SUM(COSTO) DINERO_RECOLECTADO
FROM CONSUMOS
WHERE FECHA > TO_DATE('31-DEC-1990','DD-MON-YYYY') 
AND FECHA < TO_DATE('31-DEC-2030','DD-MON-YYYY') 
GROUP BY ID_HABITACION
ORDER BY ID_HABITACION;

SELECT ID_HABITACION HABITACION, SUM(COSTO) DINERO_RECOLECTADO FROM CONSUMOS WHERE FECHA > TO_DATE('31-DEC-1995','DD-MON-YYYY') AND FECHA < TO_DATE('31-DEC-2030','DD-MON-YYYY') GROUP BY ID_HABITACION ORDER BY ID_HABITACION;

--RFC2: MOSTRAR LOS 20 SERVICIOS MÁS POPULARES.
--Preparacion: poner mas diversos consumos de servicios

SELECT * FROM (
SELECT serv.NOMBRE, COUNT(serv.NOMBRE) NUM_CONSUMOS FROM
(SELECT cons.ID_SERVICIO_COMODIDAD ID_SERVICIO FROM CONSUMOS cons
WHERE ID_SERVICIO_COMODIDAD IS NOT NULL)
INNER JOIN SERVICIOS_COMODIDAD serv
ON ID_SERVICIO = serv.ID
GROUP BY serv.NOMBRE
UNION
SELECT serv.NOMBRE, COUNT(serv.NOMBRE) NUM_CONSUMOS FROM
(SELECT cons.ID_SERVICIO_HOTEL ID_SERVICIO FROM CONSUMOS cons
WHERE ID_SERVICIO_HOTEL IS NOT NULL)
INNER JOIN SERVICIOS_HOTEL serv
ON ID_SERVICIO = serv.ID
GROUP BY serv.NOMBRE
UNION
SELECT serv.NOMBRE, COUNT(serv.NOMBRE) NUM_CONSUMOS FROM
(SELECT cons.ID_SERVICIO_PRODUCTOS ID_SERVICIO FROM CONSUMOS cons
WHERE ID_SERVICIO_PRODUCTOS IS NOT NULL)
INNER JOIN SERVICIOS_PRODUCTOS serv
ON ID_SERVICIO = serv.ID
GROUP BY serv.NOMBRE
UNION
SELECT serv.DESCRIPCION, COUNT(serv.DESCRIPCION) NUM_CONSUMOS FROM
(SELECT cons.ID_SERVICIO_SALON ID_SERVICIO FROM CONSUMOS cons
WHERE ID_SERVICIO_SALON IS NOT NULL)
INNER JOIN SERVICIOS_SALON serv
ON ID_SERVICIO = serv.ID
GROUP BY serv.DESCRIPCION
ORDER BY NUM_CONSUMOS DESC)
WHERE ROWNUM <= 20;

--REFC3: MOSTRAR EL ÍNDICE DE OCUPACIÓN DE CADA UNA DE LAS HABITACIONES DEL HOTEL
--Preparacion: crear reservas para habitaciones. Algunas representan una habitacion ya ocupada por x numero de personas, otras no.
SELECT HABITACION_ID, ROUND((NUMERO_PERSONAS/CAPACIDAD)*100,2) "OCUPACION (%)" FROM
((SELECT HABITACION_ID, NUMERO_PERSONAS FROM RESERVAS
WHERE FECHA_ENTRADA <= SYSDATE AND FECHA_SALIDA >= SYSDATE)
INNER JOIN
(SELECT ID, CAPACIDAD
FROM HABITACIONES
WHERE LLEGADA_CLIENTE = 1)
ON HABITACION_ID = ID);

--RFC4: MOSTRAR LOS SERVICIOS QUE CUMPLEN CON CIERTA CARACTERÍSTICA
--Precio en un cierto rango (servicios comodidad y salon)
SELECT * FROM(
SELECT ID, NOMBRE, COSTO FROM SERVICIOS_COMODIDAD
UNION
SELECT ID, DESCRIPCION, COSTO FROM SERVICIOS_SALON
) WHERE COSTO BETWEEN 10000 AND 70000;

--Fecha de consumo en un rango de tiempo (todos: se muestra numero de consumos)
--Reinterpretacion: servicios consumidos en x fecha (mostrar num de consumos)
SELECT serCom.NOMBRE, COUNT(serCom.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_COMODIDAD serCom
ON cons.ID_SERVICIO_COMODIDAD = serCom.ID
WHERE FECHA = TO_DATE('4-JAN-2018','DD-MON-YYYY')
GROUP BY serCom.NOMBRE

UNION

SELECT serHot.NOMBRE, COUNT(serHot.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_HOTEL serHot
ON cons.ID_SERVICIO_HOTEL = serHot.ID
WHERE FECHA = TO_DATE('4-JAN-2018','DD-MON-YYYY')
GROUP BY serHot.NOMBRE

UNION

SELECT serPro.NOMBRE, COUNT(serPro.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_PRODUCTOS serPro
ON cons.ID_SERVICIO_PRODUCTOS = serPro.ID
WHERE FECHA = TO_DATE('4-JAN-2018','DD-MON-YYYY')
GROUP BY serPro.NOMBRE

UNION

SELECT serSal.DESCRIPCION, COUNT(serSal.DESCRIPCION) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_SALON serSal
ON cons.ID_SERVICIO_SALON = serSal.ID
WHERE FECHA = TO_DATE('4-JAN-2018','DD-MON-YYYY')
GROUP BY serSal.DESCRIPCION;

--Son de cierto tipo (facil filtro)
SELECT NOMBRE FROM SERVICIOS_HOTEL;

--Han sido consumidos mas de X veces en un rango de fechas (todos: se muestra numero de consumos)
SELECT * FROM (
SELECT serSal.DESCRIPCION, COUNT(serSal.DESCRIPCION) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_SALON serSal
ON cons.ID_SERVICIO_SALON = serSal.ID
WHERE FECHA >= TO_DATE('4-JAN-2015','DD-MON-YYYY')
AND FECHA <= TO_DATE('4-JAN-2016','DD-MON-YYYY')
GROUP BY serSal.DESCRIPCION

UNION

SELECT serCom.NOMBRE, COUNT(serCom.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_COMODIDAD serCom
ON cons.ID_SERVICIO_COMODIDAD = serCom.ID
WHERE FECHA >= TO_DATE('4-JAN-2015','DD-MON-YYYY')
AND FECHA <= TO_DATE('4-JAN-2016','DD-MON-YYYY')
GROUP BY serCom.NOMBRE

UNION

SELECT serHot.NOMBRE, COUNT(serHot.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_HOTEL serHot
ON cons.ID_SERVICIO_HOTEL = serHot.ID
WHERE FECHA >= TO_DATE('4-JAN-2015','DD-MON-YYYY')
AND FECHA <= TO_DATE('4-JAN-2016','DD-MON-YYYY')
GROUP BY serHot.NOMBRE

UNION

SELECT serPro.NOMBRE, COUNT(serPro.NOMBRE) NUM_CONSUMOS FROM CONSUMOS cons
JOIN SERVICIOS_PRODUCTOS serPro
ON cons.ID_SERVICIO_PRODUCTOS = serPro.ID
WHERE FECHA >= TO_DATE('4-JAN-2015','DD-MON-YYYY')
AND FECHA <= TO_DATE('4-JAN-2016','DD-MON-YYYY')
GROUP BY serPro.NOMBRE
ORDER BY NUM_CONSUMOS DESC)
WHERE NUM_CONSUMOS > 1000;

--RFC5: MOSTRAR EL CONSUMO EN HOTELANDES POR UN USUARIO DADO, EN UN RANGO DE FECHAS INDICADO.------------------------------MODIFICADO!!!!!!!!!!!!!
SELECT COSTO, DESCRIPCION, FECHA, HABITACION_ID FROM (
SELECT HABITACION_ID, TIPO_DOCUMENTO TIP_DOC, DOCUMENTO DOC, FECHA_ENTRADA, FECHA_SALIDA FROM RESERVAS)
INNER JOIN 
(SELECT NOMBRE, TIPO_DOCUMENTO TIP_DOC_USUR, DOCUMENTO DOC_USUR FROM USUARIOS usur
WHERE usur.TIPO_DOCUMENTO = 'CC' AND usur.DOCUMENTO = '9357853112')
ON TIP_DOC = TIP_DOC_USUR AND DOC = DOC_USUR
INNER JOIN
(SELECT ID_HABITACION, COSTO, DESCRIPCION, FECHA FROM CONSUMOS
WHERE FECHA > TO_DATE('31-DEC-1990','DD-MON-YYYY') 
AND FECHA < TO_DATE('31-DEC-2030','DD-MON-YYYY'))
ON ID_HABITACION = HABITACION_ID
GROUP BY COSTO, DESCRIPCION, FECHA, HABITACION_ID;

--RFC6: ANALIZAR LA OPERACIÓN DE HOTELANDES--------------------------------------------------------------------REVISAR SYSTIMESTAMP EN JAVA
--Tipo de habitacion por mayor demanda (cantidad de veces solicitado el servicio)
SELECT COUNT(ROUND(FECHA,'DDD')) NUM_CONSUMOS,ROUND(FECHA,'DDD') FECHA_CONSUMO
FROM CONSUMOS cons
INNER JOIN
HABITACIONES hab
ON hab.ID = cons.ID_HABITACION
WHERE cons.FECHA < SYSTIMESTAMP AND 
cons.FECHA > add_months(SYSTIMESTAMP, -12) AND
TIPO = 1
GROUP BY ROUND(FECHA,'DDD')
ORDER BY COUNT(ROUND(FECHA,'DDD')) DESC, ROUND(FECHA,'DDD');

--Tipo de habitacion por mayores ingresos (suma de precio de consumos)
SELECT SUM(COSTO) INGRESOS_TOTALES, ROUND(FECHA,'DDD') FECHA_CONSUMO
FROM CONSUMOS cons
INNER JOIN
HABITACIONES hab
ON hab.ID = cons.ID_HABITACION
WHERE cons.FECHA < SYSTIMESTAMP AND 
cons.FECHA > add_months(SYSTIMESTAMP, -12) AND
TIPO = 1
GROUP BY ROUND(FECHA,'DDD')
ORDER BY SUM(COSTO) DESC;

--Tipo de servicio (restaurante/bar/etc) por mayor demanda (cantidad de veces solicitado el servicio)
SELECT COUNT(ROUND(FECHA,'DDD')) NUM_CONSUMOS,ROUND(FECHA,'DDD') FECHA_CONSUMO
FROM CONSUMOS cons
WHERE cons.FECHA < SYSTIMESTAMP AND
cons.FECHA > add_months(SYSTIMESTAMP, -12) AND
ID_SERVICIO_COMODIDAD = 1
GROUP BY ROUND(FECHA,'DDD')
ORDER BY COUNT(FECHA) DESC;

--Tipo de servicio (restaurante/bar/etc) por mayores ingresos (suma de precio de consumos)
SELECT SUM(COSTO) INGRESOS_TOTALES,ROUND(FECHA,'DDD') FECHA_CONSUMO
FROM CONSUMOS cons
WHERE cons.FECHA < SYSTIMESTAMP AND
cons.FECHA > add_months(SYSTIMESTAMP, -12) AND
ID_SERVICIO_COMODIDAD = 1
GROUP BY ROUND(FECHA,'DDD')
ORDER BY SUM(COSTO) DESC;

--RFC7: ENCONTRAR LOS BUENOS CLIENTES
--Por lo menos dos semanas (no necesariamente de seguidas) y consumo total de 15 millones.
--INNER Join con dos tablas
--Tabla 1: por lo menos 14 dias de estadia
SELECT NOMBRE, TIPO_DOC, DOC, DIAS_ESTADIA, GASTOS_TOTALES FROM (
SELECT SUM(ROUND(FECHA_SALIDA,'DDD') - ROUND(FECHA_ENTRADA,'DDD')) DIAS_ESTADIA,NOMBRE,TIP_RES TIPO_DOC,DOC_RES DOCUMENTO FROM
(SELECT FECHA_ENTRADA,FECHA_SALIDA,TIPO_DOCUMENTO TIP_RES,DOCUMENTO DOC_RES
FROM RESERVAS reser
WHERE FECHA_SALIDA < SYSTIMESTAMP AND
FECHA_SALIDA > FECHA_ENTRADA)
INNER JOIN 
(SELECT NOMBRE,TIPO_DOCUMENTO TIP_USUR,DOCUMENTO DOC_USUR FROM USUARIOS usur)
ON TIP_RES = TIP_USUR AND
DOC_RES = DOC_USUR
GROUP BY NOMBRE,TIP_RES,DOC_RES)
INNER JOIN (
--HAVING SUM(ROUND(FECHA_SALIDA,'DDD') - ROUND(FECHA_ENTRADA,'DDD')) >= 14;
--Tabla 2: por lo menos 15000000 de pesos en consumos totales
SELECT SUM(COSTO) GASTOS_TOTALES,TIPO_DOCUMENTO TIP_DOC,DOCUMENTO DOC FROM(
SELECT * FROM (
SELECT ID,FECHA, COSTO, ID_HABITACION HAB_CONS
FROM CONSUMOS)
INNER JOIN
(SELECT FECHA_ENTRADA,FECHA_SALIDA,TIPO_DOCUMENTO,DOCUMENTO,HABITACION_ID HAB_RESER
FROM RESERVAS
WHERE FECHA_SALIDA < SYSTIMESTAMP AND
FECHA_SALIDA > FECHA_ENTRADA)
ON FECHA <= FECHA_SALIDA AND
FECHA >= FECHA_ENTRADA AND
HAB_CONS = HAB_RESER)
GROUP BY TIPO_DOCUMENTO,DOCUMENTO)
ON TIPO_DOC = TIP_DOC AND DOCUMENTO = DOC
WHERE DIAS_ESTADIA >= 14 OR GASTOS_TOTALES >= 15000000;

--RFC8: ENCONTRAR LOS SERVICIOS QUE NO TIENEN MUCHA DEMANDA
SELECT * FROM(
SELECT * FROM(
SELECT NOMBRE,ID_SERVICIO,COUNT(ID_SERVICIO) NUM_SEMANAS,MIN(NUM_CONSULTAS_SEMANALES) MIN_CONSULTAS_SEMANALES FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS, NUM_CONSULTAS_SEMANALES
FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS,COUNT(ID_SERVICIO) NUM_CONSULTAS_SEMANALES FROM
(SELECT ID_SERVICIO_COMODIDAD ID_SERVICIO,TRUNC(ROUND(FECHA,'DDD'),'D') FECHAS
FROM CONSUMOS
WHERE ID_SERVICIO_COMODIDAD IS NOT NULL AND
FECHA > add_months(SYSTIMESTAMP, -12) AND
FECHA < SYSTIMESTAMP)
INNER JOIN
(SELECT ID, NOMBRE
FROM SERVICIOS_COMODIDAD
) ON ID_SERVICIO = ID
GROUP BY NOMBRE,ID_SERVICIO,FECHAS
ORDER BY NUM_CONSULTAS_SEMANALES))
GROUP BY NOMBRE,ID_SERVICIO

UNION

SELECT NOMBRE,ID_SERVICIO,COUNT(ID_SERVICIO) NUM_SEMANAS,MIN(NUM_CONSULTAS_SEMANALES) MIN_CONSULTAS_SEMANALES FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS, NUM_CONSULTAS_SEMANALES
FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS,COUNT(ID_SERVICIO) NUM_CONSULTAS_SEMANALES FROM
(SELECT ID_SERVICIO_HOTEL ID_SERVICIO,TRUNC(ROUND(FECHA,'DDD'),'D') FECHAS
FROM CONSUMOS
WHERE ID_SERVICIO_HOTEL IS NOT NULL AND
FECHA > add_months(SYSTIMESTAMP, -12) AND
FECHA < SYSTIMESTAMP)
INNER JOIN
(SELECT ID, NOMBRE
FROM SERVICIOS_HOTEL
) ON ID_SERVICIO = ID
GROUP BY NOMBRE,ID_SERVICIO,FECHAS
ORDER BY NUM_CONSULTAS_SEMANALES))
GROUP BY NOMBRE,ID_SERVICIO

UNION

SELECT NOMBRE,ID_SERVICIO,COUNT(ID_SERVICIO) NUM_SEMANAS,MIN(NUM_CONSULTAS_SEMANALES) MIN_CONSULTAS_SEMANALES FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS, NUM_CONSULTAS_SEMANALES
FROM (
SELECT NOMBRE,ID_SERVICIO,FECHAS,COUNT(ID_SERVICIO) NUM_CONSULTAS_SEMANALES FROM
(SELECT ID_SERVICIO_PRODUCTOS ID_SERVICIO,TRUNC(ROUND(FECHA,'DDD'),'D') FECHAS
FROM CONSUMOS
WHERE ID_SERVICIO_PRODUCTOS IS NOT NULL AND
FECHA > add_months(SYSTIMESTAMP, -12) AND
FECHA < SYSTIMESTAMP)
INNER JOIN
(SELECT ID, NOMBRE
FROM SERVICIOS_PRODUCTOS
) ON ID_SERVICIO = ID
GROUP BY NOMBRE,ID_SERVICIO,FECHAS
ORDER BY NUM_CONSULTAS_SEMANALES))
GROUP BY NOMBRE,ID_SERVICIO

UNION

SELECT DESCRIPCION NOMBRE,ID_SERVICIO,COUNT(ID_SERVICIO) NUM_SEMANAS,MIN(NUM_CONSULTAS_SEMANALES) MIN_CONSULTAS_SEMANALES FROM (
SELECT DESCRIPCION,ID_SERVICIO,FECHAS, NUM_CONSULTAS_SEMANALES
FROM (
SELECT DESCRIPCION,ID_SERVICIO,FECHAS,COUNT(ID_SERVICIO) NUM_CONSULTAS_SEMANALES FROM
(SELECT ID_SERVICIO_SALON ID_SERVICIO,TRUNC(ROUND(FECHA,'DDD'),'D') FECHAS
FROM CONSUMOS
WHERE ID_SERVICIO_SALON IS NOT NULL AND
FECHA > add_months(SYSTIMESTAMP, -12) AND
FECHA < SYSTIMESTAMP)
INNER JOIN
(SELECT ID, DESCRIPCION
FROM SERVICIOS_SALON
) ON ID_SERVICIO = ID
GROUP BY DESCRIPCION,ID_SERVICIO,FECHAS
ORDER BY NUM_CONSULTAS_SEMANALES))
GROUP BY DESCRIPCION,ID_SERVICIO)
WHERE NUM_SEMANAS != 53 OR MIN_CONSULTAS_SEMANALES < 3) LLENO,


(SELECT * FROM (
SELECT DESCRIPCION_SALON NOMBRE, ID_SALON ID_SERVICIO, 0 AS NUM_SEMANAS, 0 AS MIN_CONSULTAS_SEMANALES FROM
(SELECT ID ID_SALON,DESCRIPCION DESCRIPCION_SALON FROM SERVICIOS_SALON)

UNION

SELECT NOMBRE, ID_SERVICIO ID_SERVICIO, 0 AS NUM_SEMANAS, 0 AS MIN_CONSULTAS_SEMANALES FROM
(SELECT ID ID_SERVICIO,NOMBRE FROM SERVICIOS_COMODIDAD)

UNION

SELECT NOMBRE, ID_SERVICIO ID_SERVICIO, 0 AS NUM_SEMANAS, 0 AS MIN_CONSULTAS_SEMANALES FROM
(SELECT ID ID_SERVICIO,NOMBRE FROM SERVICIOS_HOTEL)

UNION

SELECT NOMBRE, ID_SERVICIO ID_SERVICIO, 0 AS NUM_SEMANAS, 0 AS MIN_CONSULTAS_SEMANALES FROM
(SELECT ID ID_SERVICIO,NOMBRE FROM SERVICIOS_PRODUCTOS))) VACIO
WHERE LLENO.ID_SERVICIO = VACIO.ID_SERVICIO AND LLENO.NOMBRE = VACIO.NOMBRE (+);

--RFC9: Clientes que han consumido al menos una vez un servicio
SELECT TIPO_DOCUMENTO, DOCUMENTO, TIPO, NOMBRE, CORREO, VECES_CONSUMIDO, FECHA FROM
(SELECT TIPO_DOCUMENTO TIPO_DOC, DOCUMENTO DOC, COUNT(DOCUMENTO) VECES_CONSUMIDO, FECHA FROM CONSUMOS
JOIN RESERVAS
ON ID_HABITACION = HABITACION_ID
AND FECHA <= FECHA_SALIDA
AND FECHA >= FECHA_ENTRADA
WHERE ID_SERVICIO_PRODUCTOS = 3
AND FECHA BETWEEN TO_DATE('31-DEC-2000','DD-MON-YYYY') AND TO_DATE('31-DEC-2005','DD-MON-YYYY')
GROUP BY DOCUMENTO, TIPO_DOCUMENTO, FECHA)
JOIN USUARIOS
ON USUARIOS.TIPO_DOCUMENTO = TIPO_DOC AND USUARIOS.DOCUMENTO = DOC
ORDER BY VECES_CONSUMIDO DESC;

----Variante organizador eventos
SELECT TIPO_DOCUMENTO, DOCUMENTO, TIPO, NOMBRE, CORREO, VECES_CONSUMIDO, FECHA FROM
(SELECT TIPO_DOCUMENTO TIPO_DOC, DOCUMENTO DOC, COUNT(DOCUMENTO) VECES_CONSUMIDO, FECHA FROM CONSUMOS
JOIN (SELECT RESERVAS.* FROM RESERVAS
JOIN CONVENCIONES
ON RESERVAS.CONVENCION_ID = CONVENCIONES.ID)
ON ID_HABITACION = HABITACION_ID
AND FECHA <= FECHA_SALIDA
AND FECHA >= FECHA_ENTRADA
WHERE ID_SERVICIO_COMODIDAD = 1
AND FECHA BETWEEN TO_DATE('31-DEC-2000','DD-MON-YYYY') AND TO_DATE('31-DEC-2019','DD-MON-YYYY')
GROUP BY DOCUMENTO, TIPO_DOCUMENTO, FECHA)
JOIN USUARIOS
ON USUARIOS.TIPO_DOCUMENTO = TIPO_DOC AND USUARIOS.DOCUMENTO = DOC
ORDER BY VECES_CONSUMIDO DESC;

--RFC9: Clientes que NO han consumido un servicio
SELECT TIPO_DOCUMENTO2 TIPO_DOCUMENTO, DOCUMENTO2 DOCUMENTO, TIPO2 TIPO, NOMBRE2 NOMBRE, CORREO2 CORREO FROM (
(SELECT TIPO_DOCUMENTO, DOCUMENTO, TIPO, NOMBRE, CORREO FROM
(SELECT TIPO_DOCUMENTO TIPO_DOC, DOCUMENTO DOC FROM CONSUMOS
JOIN (SELECT RESERVAS.* FROM RESERVAS
JOIN CONVENCIONES
ON RESERVAS.CONVENCION_ID = CONVENCIONES.ID)
ON ID_HABITACION = HABITACION_ID
AND FECHA <= FECHA_SALIDA
AND FECHA >= FECHA_ENTRADA
WHERE ID_SERVICIO_COMODIDAD = 1
AND FECHA BETWEEN TO_DATE('31-DEC-2000','DD-MON-YYYY') AND TO_DATE('31-DEC-2019','DD-MON-YYYY')
GROUP BY DOCUMENTO, TIPO_DOCUMENTO)
JOIN USUARIOS
ON USUARIOS.TIPO_DOCUMENTO = TIPO_DOC AND USUARIOS.DOCUMENTO = DOC))
RIGHT JOIN
(SELECT TIPO_DOCUMENTO TIPO_DOCUMENTO2, DOCUMENTO DOCUMENTO2, TIPO TIPO2, NOMBRE NOMBRE2, CORREO CORREO2 FROM USUARIOS)
ON TIPO_DOCUMENTO = TIPO_DOCUMENTO2 AND DOCUMENTO = DOCUMENTO2 AND TIPO = TIPO2 AND NOMBRE = NOMBRE2
WHERE TIPO2 = 'CLIENTE' AND CORREO IS NULL;

--RFC10: CONSULTAR FUNCIONAMIENTO
SELECT PRIMER_DIA_SEMANA, SERVICIO, MAX(COUNT(SERVICIO)) FROM(
SELECT ROUND(TO_TIMESTAMP (FECHA),'MONTH') PRIMER_DIA_SEMANA, CONCAT(ID_SERVICIO_COMODIDAD, 'COMODIDAD') AS "SERVICIO" FROM CONSUMOS
WHERE EXTRACT(YEAR FROM  FECHA)  = 2000 AND ID_SERVICIO_COMODIDAD IS NOT NULL
UNION
SELECT ROUND(TO_TIMESTAMP (FECHA),'MONTH'), CONCAT(ID_SERVICIO_HOTEL, 'HOTEL') AS "SERVICIO" FROM CONSUMOS
WHERE EXTRACT(YEAR FROM  FECHA)  = 2000 AND ID_SERVICIO_HOTEL IS NOT NULL
UNION
SELECT ROUND(TO_TIMESTAMP (FECHA),'MONTH'), CONCAT(ID_SERVICIO_PRODUCTOS, 'PRODUCTOS') AS "SERVICIO" FROM CONSUMOS
WHERE EXTRACT(YEAR FROM  FECHA)  = 2000 AND ID_SERVICIO_PRODUCTOS IS NOT NULL
UNION
SELECT ROUND(TO_TIMESTAMP (FECHA),'MONTH'), CONCAT(ID_SERVICIO_SALON,'SALON') AS "SERVICIO" FROM CONSUMOS
WHERE EXTRACT(YEAR FROM  FECHA)  = 2000 AND ID_SERVICIO_SALON IS NOT NULL)

ORDER BY PRIMER_DIA_SEMANA, SERVICIO;